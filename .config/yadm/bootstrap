#!/bin/bash

# Move .weztern.lua to Windows on wsl
if [ $(uname -r | sed -n 's/.*\( *Microsoft *\).*/\1/ip') ]; then
  # Move .wezterm.lua to Windows home
  WIN_HOME="/mnt/c/Users/$(whoami)"
  if [ -d $WIN_HOME ]; then
    cp "$HOME/.wezterm.lua" "$WIN_HOME/.wezterm.lua"
  fi
fi

# Send to background
{

# Install packages
if command -v apt >/dev/null; then
  sudo apt update
  # Building neovim
  sudo apt install -y gcc ninja-build gettext cmake curl build-essential
  # Building Luarocks
  sudo apt install -y libreadline-dev unzip
  # Neovim checkhealth
  sudo apt install -y ripgrep
fi

# Build neovim
cd $HOME && mkdir src && cd src
git clone https://github.com/neovim/neovim
cd neovim
git checkout stable
make CMAKE_BUILD_TYPE=Release
sudo make install

# Build Luarocks (for lazy vim)
cd $HOME/src
wget https://luarocks.org/releases/luarocks-3.11.1.tar.gz
tar zxpf luarocks-3.11.1
./configure && make && sudo make install
sudo luarocks install luasocket

# Initialise nvim
nvim --headless -c "Lazy sync" -c "qa"

} &

# Set up ssh key
if [ ! -f ~/.ssh/id_ed25519 ]; then
  ssh-keygen -t ed25519
  ssh-add ~/.ssh/id_ed25519
fi

# Show ssh key
echo "Copying generated SSH key to clipboard. Press enter to foreground setup."
cat ~/.ssh/id_ed25519.pub && clip < ~/.ssh/id_ed25519.pub
read
fg
