#!/bin/bash

# Get the users sudo password
sudo -v

# Move .wezterm.lua to Windows home on wsl
if [ $(uname -r | sed -n 's/.*\( *Microsoft *\).*/\1/ip') ]; then
  WIN_HOME="/mnt/c/Users/$(whoami)"
  if [ -d $WIN_HOME ]; then
    cp "$HOME/.wezterm.lua" "$WIN_HOME/.wezterm.lua"
  fi
fi

# Install homebrow if it isn't already installed.
if ! command -v brew 2>&1 >/dev/null; then
  # Requirements when on linux
  if command -v apt 2>&1 >/dev/null; then
    sudo apt update && sudo apt install build-essential procps curl file git
  elif command -v pacman 2>&1 >/dev/null; then
    sudo pacman -Sy base-devel procps-ng curl file git
  elif command -v yum 2>&1 >/dev/null; then
    sudo yum groupinstall 'Development Tools'
    sudo yum update && sudo yum install procps-ng curl file git
  fi
  
  NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  export PATH="/opt/homebrew/bin:/home/linuxbrew/.linuxbrew/bin:/usr/local/bin:$PATH"
  eval "$(brew shellenv)"
fi

# Install packages
if command -v brew >/dev/null; then
  brew update
  # Basics
  brew install gcc fzf xclip
  # Neovim
  brew install neovim ripgrep tree-sitter node npm luarocks
  # LSPs
  brew install lua-language-server
  # Extras
  brew install yazi
fi

# Install rust
if ! command -v cargo >/dev/null; then
  curl https://sh.rustup.rs -sSf | sh -s -- -y
  source "$HOME/.cargo/env"
fi

# Initialise nvim
nvim --headless -c "Lazy sync" -c "qa"

# Set git config
git config --global user.name "Kai Chevannes"
git config --global core.editor "nvim"

# Set up ssh key
if [ ! -f ~/.ssh/id_ed25519 ]; then
  ssh-keygen -t ed25519 -N "" -f ~/.ssh/id_ed25519
  eval "$(ssh-agent -s)"
  ssh-add ~/.ssh/id_ed25519
fi

# Show ssh key
echo -e "\n\033[34mCopying generated SSH key to clipboard.\033[0m"
cat ~/.ssh/id_ed25519.pub | tee /dev/tty | xclip -selection clipboard
echo -e "\n\033[34mTo finish setup, run: git config --global user.email \"your_email@example.com\"\033[0m"
